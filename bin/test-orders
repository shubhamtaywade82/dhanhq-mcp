#!/usr/bin/env ruby
# frozen_string_literal: true

# Manual test script for orders.prepare
# Usage: bin/test-orders
#
# Note: orders.prepare is intent-only (no API calls, just validation)
# Requires: CLIENT_ID and ACCESS_TOKEN in .env file (for Instrument lookups)

$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))

require "dotenv/load"
require "dhan_hq"
require "dhanhq-mcp"

# Configure DhanHQ from environment
DhanHQ.configure_with_env
DhanHQ.logger.level = (ENV["DHAN_LOG_LEVEL"] || "INFO").upcase.then { |level| Logger.const_get(level) }

# Create context
client = Object.new
context = Dhanhq::Mcp::Context.new(client: client)

puts "=== Testing orders.prepare (BUY) ==="
result = Dhanhq::Mcp::Tools::Orders.new(context).prepare(
  "exchange_segment" => "NSE_EQ",
  "symbol" => "RELIANCE",
  "transaction_type" => "BUY",
  "quantity" => 1,
  "order_type" => "LIMIT",
  "product_type" => "INTRADAY",
  "price" => 2500.0,
  "stop_loss" => 2480.0,
  "target" => 2550.0,
)
puts JSON.pretty_generate(result)

puts "\n=== Testing orders.prepare (SELL) ==="
result = Dhanhq::Mcp::Tools::Orders.new(context).prepare(
  "exchange_segment" => "NSE_EQ",
  "symbol" => "TCS",
  "transaction_type" => "SELL",
  "quantity" => 1,
  "order_type" => "MARKET",
  "product_type" => "CNC",
)
puts JSON.pretty_generate(result)

puts "\nâœ… CHECKPOINT PASSED - orders.prepare working"
puts "\nNOTE: Intent prepared successfully. Execution requires human confirmation."
