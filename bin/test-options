#!/usr/bin/env ruby
# frozen_string_literal: true

# Manual test script for Options tools
# Usage: bin/test-options
#
# Note: option.expiries and option.chain require authentication (API calls)
#       option.select uses authenticated option chain data
#       option.prepare is intent-only (no API calls, just validation)
#
# Requires: CLIENT_ID and ACCESS_TOKEN in .env file

$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))

require "dotenv/load"
require "dhan_hq"
require "dhanhq-mcp"

# Configure DhanHQ from environment
DhanHQ.configure_with_env
DhanHQ.logger.level = (ENV["DHAN_LOG_LEVEL"] || "INFO").upcase.then { |level| Logger.const_get(level) }

# Create context (not used by options tools, but required by architecture)
client = Object.new
context = Dhanhq::Mcp::Context.new(client: client)

puts "=== Testing option.expiries ==="
result = Dhanhq::Mcp::Tools::Options::Expiries.new(context).call(
  "exchange_segment" => "IDX_I",
  "symbol" => "NIFTY",
)
puts JSON.pretty_generate(result)

puts "\n=== Testing option.chain ==="
expiry = result.first
result = Dhanhq::Mcp::Tools::Options::Chain.new(context).call(
  "exchange_segment" => "IDX_I",
  "symbol" => "NIFTY",
  "expiry" => expiry,
)
puts "Chain length: #{result.length}"
puts JSON.pretty_generate(result.first(2))

puts "\nâœ… CHECKPOINT PASSED - Options tools working"
puts "\nNOTE: option.select and option.prepare require additional parameters"
puts "Test those manually with real spot price and strike data"
