# Recommendation Response Schema

This document defines a strict JSON response schema for recommendations generated by
agent-runtime or Rails services. It is not a replacement for MCP tool responses; it
is a contract for downstream consumers (UI, logs, audit, or execution workflows).

## Design Goals

- Deterministic structure across prompt categories.
- Clear separation between recommendations and execution.
- Explicit error and rejection shapes.
- Machine-validated contract via JSON Schema.

## JSON Schema (draft-07)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RecommendationResponse",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "response_type",
    "request_id",
    "generated_at",
    "category",
    "status"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "enum": ["1.0"]
    },
    "response_type": {
      "const": "recommendation"
    },
    "request_id": {
      "type": "string"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time"
    },
    "category": {
      "type": "string",
      "enum": [
        "informational",
        "analytical",
        "strike_selection",
        "trade_intent"
      ]
    },
    "status": {
      "type": "string",
      "enum": ["ok", "rejected", "error"]
    },
    "summary": {
      "type": "string"
    },
    "data_basis": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tools", "as_of", "inputs"],
      "properties": {
        "tools": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "as_of": {
          "type": "string",
          "format": "date-time"
        },
        "inputs": {
          "type": "object"
        },
        "market_session": {
          "type": "string",
          "enum": ["open", "closed", "unknown"]
        }
      }
    },
    "recommendations": {
      "type": "array",
      "items": { "$ref": "#/definitions/recommendation" }
    },
    "actions": {
      "type": "array",
      "items": { "$ref": "#/definitions/action" }
    },
    "warnings": {
      "type": "array",
      "items": { "type": "string" }
    },
    "error": {
      "$ref": "#/definitions/error"
    }
  },
  "allOf": [
    {
      "if": { "properties": { "status": { "const": "ok" } } },
      "then": {
        "required": ["recommendations"]
      }
    },
    {
      "if": { "properties": { "status": { "enum": ["rejected", "error"] } } },
      "then": {
        "required": ["error"]
      }
    }
  ],
  "definitions": {
    "instrument": {
      "type": "object",
      "additionalProperties": false,
      "required": ["exchange_segment", "symbol"],
      "properties": {
        "exchange_segment": { "type": "string" },
        "symbol": { "type": "string" },
        "security_id": { "type": "string" },
        "expiry": { "type": "string" },
        "strike": { "type": "number" },
        "option_type": { "type": "string", "enum": ["CE", "PE"] }
      }
    },
    "recommendation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "rank", "type", "instrument", "rationale"],
      "properties": {
        "id": { "type": "string" },
        "rank": { "type": "integer", "minimum": 1 },
        "type": {
          "type": "string",
          "enum": ["analysis", "strike", "intent"]
        },
        "instrument": { "$ref": "#/definitions/instrument" },
        "metrics": { "type": "object" },
        "rationale": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "action": { "$ref": "#/definitions/action" }
      }
    },
    "action": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["prepare_trade", "request_confirmation", "none"]
        },
        "tool": {
          "type": "string",
          "enum": ["orders.prepare", "option.prepare"]
        },
        "arguments": {
          "type": "object"
        }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "prepare_trade" } } },
          "then": { "required": ["tool", "arguments"] }
        }
      ]
    },
    "error": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "message"],
      "properties": {
        "code": { "type": "string" },
        "message": { "type": "string" },
        "details": { "type": "object" }
      }
    }
  }
}
```

## Example: Strike Selection Recommendation

```json
{
  "schema_version": "1.0",
  "response_type": "recommendation",
  "request_id": "req_01J0XYZABC123",
  "generated_at": "2026-01-17T10:05:00+05:30",
  "category": "strike_selection",
  "status": "ok",
  "summary": "Top CE strikes near ATM based on distance and premium filters.",
  "data_basis": {
    "tools": ["instrument.ltp", "option.chain"],
    "as_of": "2026-01-17T10:05:00+05:30",
    "inputs": {
      "exchange_segment": "IDX_I",
      "symbol": "NIFTY",
      "expiry": "2026-01-22",
      "direction": "BULLISH"
    },
    "market_session": "open"
  },
  "recommendations": [
    {
      "id": "rec_1",
      "rank": 1,
      "type": "strike",
      "instrument": {
        "exchange_segment": "IDX_I",
        "symbol": "NIFTY",
        "security_id": "12345",
        "expiry": "2026-01-22",
        "strike": 22000,
        "option_type": "CE"
      },
      "metrics": { "premium": 110, "distance_from_spot_pct": 0.2 },
      "rationale": [
        "Near ATM with acceptable premium",
        "Liquidity appears sufficient for intraday"
      ],
      "action": {
        "type": "prepare_trade",
        "tool": "option.prepare",
        "arguments": {
          "exchange_segment": "IDX_I",
          "symbol": "NIFTY",
          "security_id": "12345",
          "option_type": "CE",
          "strike": 22000,
          "expiry": "2026-01-22",
          "quantity": 50,
          "stop_loss": 80,
          "target": 160
        }
      }
    }
  ]
}
```

## Example: Rejected Request

```json
{
  "schema_version": "1.0",
  "response_type": "recommendation",
  "request_id": "req_01J0XYZABC999",
  "generated_at": "2026-01-17T10:05:00+05:30",
  "category": "trade_intent",
  "status": "rejected",
  "error": {
    "code": "unsupported_prompt",
    "message": "Bulk trading requests are not supported.",
    "details": { "reason": "unsafe_bulk_request" }
  }
}
```
